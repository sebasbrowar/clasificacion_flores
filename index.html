<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clasificador de Flores</title>
    <!-- Usamos versi√≥n espec√≠fica compatible con tu conversi√≥n -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.18.0/dist/tf.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', sans-serif;
            margin: 0;
            padding: 20px;
            background: #f0f8ff;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }
        #camera-container {
            position: relative;
            width: 224px;
            height: 224px;
            margin: 20px 0;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 6px 15px rgba(0,0,0,0.15);
            border: 3px solid #4CAF50;
        }
        #webcam {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transform: scaleX(-1);
        }
        #result {
            font-size: 24px;
            padding: 15px 25px;
            background: white;
            border-radius: 25px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
            margin-top: 15px;
            min-width: 250px;
            text-align: center;
            border: 2px solid #e0e0e0;
            min-height: 80px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        h1 {
            color: #2E7D32;
            margin-bottom: 20px;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
        }
        .emoji {
            font-size: 28px;
            margin-bottom: 5px;
        }
        .flower-name {
            font-weight: bold;
            margin: 5px 0;
            font-size: 20px;
        }
        .confidence {
            font-size: 16px;
            color: #555;
        }
        #error {
            color: #d32f2f;
            margin-top: 10px;
            text-align: center;
            max-width: 300px;
        }
    </style>
</head>
<body>
    <h1>üåº Clasificador de Flores üå∏</h1>
    
    <div id="camera-container">
        <video id="webcam" width="224" height="224" autoplay playsinline></video>
    </div>
    
    <div id="result">Inicializando aplicaci√≥n...</div>
    <div id="error"></div>

    <script>
        // 1. Lista de clases (104 flores)
        const CLASSES = [
            'pink primrose', 'hard-leaved pocket orchid', 'canterbury bells', 'sweet pea', 'wild geranium',
            'tiger lily', 'moon orchid', 'bird of paradise', 'monkshood', 'globe thistle',
            'snapdragon', "colt's foot", 'king protea', 'spear thistle', 'yellow iris',
            'globe-flower', 'purple coneflower', 'peruvian lily', 'balloon flower', 'giant white arum lily',
            'fire lily', 'pincushion flower', 'fritillary', 'red ginger', 'grape hyacinth',
            'corn poppy', 'prince of wales feathers', 'stemless gentian', 'artichoke', 'sweet william',
            'carnation', 'garden phlox', 'love in the mist', 'cosmos', 'alpine sea holly',
            'ruby-lipped cattleya', 'cape flower', 'great masterwort', 'siam tulip', 'lenten rose',
            'barberton daisy', 'daffodil', 'sword lily', 'poinsettia', 'bolero deep blue',
            'wallflower', 'marigold', 'buttercup', 'daisy', 'common dandelion',
            'petunia', 'wild pansy', 'primula', 'sunflower', 'lilac hibiscus',
            'bishop of llandaff', 'gaura', 'geranium', 'orange dahlia', 'pink-yellow dahlia',
            'cautleya spicata', 'japanese anemone', 'black-eyed susan', 'silverbush', 'californian poppy',
            'osteospermum', 'spring crocus', 'iris', 'windflower', 'tree poppy',
            'gazania', 'azalea', 'water lily', 'rose', 'thorn apple',
            'morning glory', 'passion flower', 'lotus', 'toad lily', 'anthurium',
            'frangipani', 'clematis', 'hibiscus', 'columbine', 'desert-rose',
            'tree mallow', 'magnolia', 'cyclamen', 'watercress', 'canna lily',
            'hippeastrum', 'bee balm', 'pink quill', 'foxglove', 'bougainvillea',
            'camellia', 'mallow', 'mexican petunia', 'bromelia', 'blanket flower',
            'trumpet creeper', 'blackberry lily', 'common tulip', 'wild rose'
        ];

        // 2. Variables de estado
        let model;
        let currentStream = null;
        let isPredicting = false;
        const emojis = ['üå∑', 'üå∏', 'üåπ', 'üå∫', 'üåª', 'üåº', 'üíê', 'üèµÔ∏è'];

        class Rescaling extends tf.layers.Layer {
            constructor(config) {
                super(config);
                this.scale = config.scale || 1.0;
                this.offset = config.offset || 0.0;
            }

            call(inputs) {
                return tf.mul(inputs, this.scale).add(this.offset);
            }

            static get className() {
                return 'Rescaling';
            }
        }

        tf.serialization.registerClass(Rescaling);


        // 3. Cargar modelo con compatibilidad para TF 2.19
        async function loadModel() {
            try {
                showStatus("Cargando modelo...");
                
                // Intenta cargar como GraphModel (formato recomendado para TF 2.x)
                model = await tf.loadLayersModel('modelo/model.json');
                
                // Verificaci√≥n de compatibilidad
                if (!model.inputs || model.inputs.length === 0) {
                    throw new Error("El modelo no tiene entradas definidas");
                }
                
                // Muestra informaci√≥n del modelo cargado
                console.log("Modelo cargado:", model);
                console.log("Forma de entrada:", model.inputs[0].shape);
                
                showStatus("Modelo listo. Enfoca una flor con la c√°mara");
                return true;
                
            } catch (error) {
                console.error("Error al cargar el modelo:", error);
                showError(`Error al cargar el modelo: ${error.message.split('\n')[0]}`);
                return false;
            }
        }

        // 4. Configurar c√°mara trasera
        async function setupCamera() {
            stopCamera();
            
            try {
                const video = document.getElementById('webcam');
                const constraints = {
                    video: {
                        width: 224,
                        height: 224,
                        facingMode: { exact: "environment" }, // Fuerza c√°mara trasera
                        frameRate: { ideal: 30 }
                    }
                };
                
                currentStream = await navigator.mediaDevices.getUserMedia(constraints);
                video.srcObject = currentStream;
                
                return new Promise((resolve) => {
                    video.onloadedmetadata = () => {
                        video.play();
                        resolve(video);
                    };
                });
            } catch (error) {
                console.error("Error en la c√°mara:", error);
                showError("No se pudo acceder a la c√°mara trasera. Aseg√∫rate de permitir los permisos.");
                throw error;
            }
        }

        // 5. Preprocesamiento para modelos EfficientNet
        function preprocessImage(image) {
            return tf.tidy(() => {
                // Convertir a tensor y redimensionar
                const tensor = tf.browser.fromPixels(image)
                    .resizeNearestNeighbor([224, 224])
                    .toFloat();
                
                // Normalizaci√≥n para EfficientNet: [0,255] -> [-1,1]
                return tensor.div(127.5).sub(1.0).expandDims(0);
            });
        }

        // 6. Clasificaci√≥n de im√°genes
        async function classifyImage() {
            if (!model || isPredicting) return;
            
            isPredicting = true;
            const video = document.getElementById('webcam');
            const resultDiv = document.getElementById('result');
            
            try {
                // Preprocesamiento
                const tensor = preprocessImage(video);
                
                // Predicci√≥n
                const predictions = await model.predict(tensor).data();
                tensor.dispose();
                
                // Procesar resultados
                const maxProb = Math.max(...predictions);
                const classIndex = predictions.indexOf(maxProb);
                const confidence = (maxProb * 100).toFixed(1);
                
                // Mostrar resultados
                showResult(
                    CLASSES[classIndex] || 'Desconocido', 
                    confidence,
                    emojis[classIndex % emojis.length]
                );
                
            } catch (error) {
                console.error("Error en la predicci√≥n:", error);
                showStatus("Error al clasificar la imagen");
            } finally {
                isPredicting = false;
            }
        }

        // Helper functions
        function showStatus(message) {
            document.getElementById('result').textContent = message;
            document.getElementById('error').textContent = '';
        }
        
        function showError(message) {
            document.getElementById('error').textContent = message;
        }
        
        function showResult(flowerName, confidence, emoji) {
            document.getElementById('result').innerHTML = `
                <span class="emoji">${emoji}</span>
                <div class="flower-name">${flowerName}</div>
                <div class="confidence">${confidence}% de confianza</div>
            `;
        }

        // 7. Inicializaci√≥n
        (async function init() {
            // Verificar compatibilidad
            if (!tf.ready()) {
                showError("TensorFlow.js no est√° listo. Recarga la p√°gina.");
                return;
            }
            
            // Cargar modelo
            const modelLoaded = await loadModel();
            if (!modelLoaded) return;
            
            // Configurar c√°mara
            try {
                await setupCamera();
                
                // Iniciar bucle de predicci√≥n
                setInterval(classifyImage, 1500);
                
            } catch (error) {
                console.error("Error en inicializaci√≥n:", error);
            }
            
            // Limpieza
            window.addEventListener('beforeunload', () => {
                stopCamera();
                if (model) model.dispose();
            });
        })();

        function stopCamera() {
            if (currentStream) {
                currentStream.getTracks().forEach(track => track.stop());
                currentStream = null;
            }
        }
    </script>
</body>
</html>


