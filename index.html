<!doctype html>
<html lang="es">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Clasificador de Flores</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">

    <style>
      #flower-label {
        position: absolute;
        bottom: 10px;
        left: 0;
        right: 0;
        background-color: rgba(0, 0, 0, 0.7);
        color: white;
        padding: 10px;
        text-align: center;
        font-size: 1.5rem;
        border-radius: 0 0 5px 5px;
      }
      .video-container {
        position: relative;
        display: inline-block;
        margin-bottom: 20px;
      }
      canvas {
        border-radius: 5px;
        display: block;
      }
      #modelo-activo {
        font-size: 1.2rem;
        text-align: center;
        margin: 15px 0;
        color: #0d6efd;
        font-weight: bold;
      }
      .confidence {
        font-size: 1rem;
        opacity: 0.8;
      }
    </style>
  </head>
  <body>

    <main>
      <div class="px-4 py-2 my-2 text-center border-bottom">
        <img class="d-block mx-auto mb-2" src="mcd.png" alt="" width="80" height="80">
        <h1 class="display-5 fw-bold">Clasificador de Flores</h1>
        <div class="col-lg-6 mx-auto">
          <p class="lead mb-0">Identificación de tipos de flores</p>
        </div>
      </div>

      <div class="container mt-4">
        <div class="row">
          <div class="col-12 col-md-6 offset-md-3 text-center">
            <div id="modelo-activo">Modelo cargado: Clasificador de Flores</div>
            
            <div class="video-container">
              <video id="video" playsinline autoplay style="display: none;"></video>
              <canvas id="canvas" width="400" height="400" style="max-width: 100%;"></canvas>
              <div id="flower-label">
                <div id="flower-name">Apunte a una flor</div>
                <div id="flower-confidence" class="confidence"></div>
              </div>
            </div>
            
            <button class="btn btn-primary mb-4" id="cambiar-camara" onclick="cambiarCamara();">
              <i class="bi bi-camera-reverse"></i> Cambiar cámara
            </button>
            
            <canvas id="processing-canvas" width="224" height="224" style="display: none;"></canvas>
          </div>
        </div>
      </div>

      <div class="bg-dark text-secondary px-4 py-5 text-center">
        <div class="py-5">
          <div class="col-lg-6 mx-auto">
            <p class="fs-5 mb-4">Sistema de clasificación de flores en tiempo real</p>
          </div>
        </div>
      </div>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.22.0/dist/tf.min.js"></script>

    <script type="text/javascript">
      // Configuración principal
      const video = document.getElementById('video');
      const canvas = document.getElementById('canvas');
      const processingCanvas = document.getElementById('processing-canvas');
      const ctx = canvas.getContext('2d');
      const processingCtx = processingCanvas.getContext('2d');
      const flowerName = document.getElementById('flower-name');
      const flowerConfidence = document.getElementById('flower-confidence');
      
      let currentStream = null;
      let facingMode = "environment"; // Por defecto cámara trasera
      const displaySize = 400; // Tamaño de visualización
      
      // Modelo y clases
      let modelo = null;
      const clasesFlores = [
            'pink primrose', 'hard-leaved pocket orchid', 'canterbury bells', 'sweet pea', 'wild geranium',
            'tiger lily', 'moon orchid', 'bird of paradise', 'monkshood', 'globe thistle',
            'snapdragon', "colt's foot", 'king protea', 'spear thistle', 'yellow iris',
            'globe-flower', 'purple coneflower', 'peruvian lily', 'balloon flower', 'giant white arum lily',
            'fire lily', 'pincushion flower', 'fritillary', 'red ginger', 'grape hyacinth',
            'corn poppy', 'prince of wales feathers', 'stemless gentian', 'artichoke', 'sweet william',
            'carnation', 'garden phlox', 'love in the mist', 'cosmos', 'alpine sea holly',
            'ruby-lipped cattleya', 'cape flower', 'great masterwort', 'siam tulip', 'lenten rose',
            'barberton daisy', 'daffodil', 'sword lily', 'poinsettia', 'bolero deep blue',
            'wallflower', 'marigold', 'buttercup', 'daisy', 'common dandelion',
            'petunia', 'wild pansy', 'primula', 'sunflower', 'lilac hibiscus',
            'bishop of llandaff', 'gaura', 'geranium', 'orange dahlia', 'pink-yellow dahlia',
            'cautleya spicata', 'japanese anemone', 'black-eyed susan', 'silverbush', 'californian poppy',
            'osteospermum', 'spring crocus', 'iris', 'windflower', 'tree poppy',
            'gazania', 'azalea', 'water lily', 'rose', 'thorn apple',
            'morning glory', 'passion flower', 'lotus', 'toad lily', 'anthurium',
            'frangipani', 'clematis', 'hibiscus', 'columbine', 'desert-rose',
            'tree mallow', 'magnolia', 'cyclamen', 'watercress', 'canna lily',
            'hippeastrum', 'bee balm', 'pink quill', 'foxglove', 'bougainvillea',
            'camellia', 'mallow', 'mexican petunia', 'bromelia', 'blanket flower',
            'trumpet creeper', 'blackberry lily', 'common tulip', 'wild rose'
        ]; // Ajustar según tu modelo
      
      // Cargar el modelo al iniciar
      (async function init() {
        try {
          console.log("Cargando modelo de flores...");
          modelo = await tf.loadLayersModel("modelo/model.json"); // Ajustar ruta
          console.log("Modelo de flores cargado correctamente");
          mostrarCamara();
        } catch (error) {
          console.error("Error al cargar el modelo:", error);
          flowerName.textContent = "Error al cargar el modelo";
        }
      })();
      
      // Configurar y mostrar la cámara
      function mostrarCamara() {
        const constraints = {
          audio: false,
          video: {
            facingMode: facingMode,
            width: { ideal: displaySize },
            height: { ideal: displaySize }
          }
        };
        
        if (currentStream) {
          currentStream.getTracks().forEach(track => track.stop());
        }
        
        navigator.mediaDevices.getUserMedia(constraints)
          .then(stream => {
            currentStream = stream;
            video.srcObject = stream;
            video.onloadedmetadata = () => {
              video.play();
              procesarCamara();
              predecir();
            };
          })
          .catch(err => {
            console.error("Error al acceder a la cámara:", err);
            flowerName.textContent = "Error al acceder a la cámara";
          });
      }
      
      // Procesamiento continuo del video
      function procesarCamara() {
        if (video.readyState === video.HAVE_ENOUGH_DATA) {
          ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
        }
        requestAnimationFrame(procesarCamara);
      }
      
      // Cambiar entre cámaras
      function cambiarCamara() {
        facingMode = facingMode === "user" ? "environment" : "user";
        mostrarCamara();
      }
      
      // Función de predicción principal
      async function predecir() {
        if (!modelo || !video.readyState) {
          setTimeout(predecir, 300);
          return;
        }
        
        try {
          // 1. Redimensionar y preparar la imagen para el modelo
          processingCtx.drawImage(video, 0, 0, processingCanvas.width, processingCanvas.height);
          
          // 2. Obtener los datos de imagen y crear tensor
          const imgData = processingCtx.getImageData(0, 0, processingCanvas.width, processingCanvas.height);
          let tensor = tf.browser.fromPixels(imgData)
            .toFloat()
            .div(255.0) // Normalizar a [0,1]
            .expandDims(); // Añadir dimensión batch
          
          // 3. Realizar predicción
          const predicciones = await modelo.predict(tensor).data();
          tensor.dispose(); // Liberar memoria
          
          // 4. Procesar resultados
          const maxPred = Math.max(...predicciones);
          const indiceMax = predicciones.indexOf(maxPred);
          const confidence = (maxPred * 100).toFixed(1);
          
          // 5. Mostrar resultados
          flowerName.textContent = clasesFlores[indiceMax] || "Flor no reconocida";
          flowerConfidence.textContent = `${confidence}% de confianza`;
          
        } catch (error) {
          console.error("Error en la predicción:", error);
          flowerName.textContent = "Error en la predicción";
          flowerConfidence.textContent = "";
        }
        
        setTimeout(predecir, 500); // Controlar la frecuencia de predicciones
      }
      
      // Manejar cierre de la página
      window.addEventListener('beforeunload', () => {
        if (currentStream) {
          currentStream.getTracks().forEach(track => track.stop());
        }
      });
    </script>
  </body>
</html>